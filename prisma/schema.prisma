// schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // Use an environment variable for the database connection
}

model Clinic {
  id                 Int               @id @default(autoincrement())
  email              String            @unique
  createdOn          DateTime          @default(now())
  name               String
  address            String?
  phone              String?
  workHours          String? // E.g., "9:30 AM - 6:00 PM"
  logo               String? // URL or file path of the logo image
  brandColor         String? @default("#2B3E8F")
  
  Subscription       Subscription[]  
  User               User[]
  Patient            Patient[]
  Appointment        Appointment[]
  Doctor             Doctor[]
  Receptionist       Receptionist[]
  InvoicePrefills    InvoicePrefills[]
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
}

model User {
  id                   Int       @id @default(autoincrement())
  firstName            String
  lastName             String?
  email                String    @unique
  password             String
  role                 Role      @default(ADMIN)
  JWT                  String?
  clinicId             Int
  Clinic               Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  Doctor               Doctor?
  Receptionist         Receptionist?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime? 
  lastLoginAt          DateTime?
  AppointmentCreated   Appointment[]
  InvoiceUpdated       Invoice[]

  @@index([clinicId])
}

model Receptionist {
  id              Int       @id @default(autoincrement())

  firstName       String
  lastName        String?
  phone           String?
  email           String?
  Address         String?
  Age             Int?
  isActive        Boolean   @default(true)

  userId          Int       @unique
  User            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  clinicId        Int
  Clinic          Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([clinicId])
}


model Patient {
  id               Int       @id @default(autoincrement())
  firstName        String
  lastName         String?
  email            String?    
  phone            String   
  emergencyContact String? 
  gender           Gender
  dob              DateTime
  bloodGroup       BloodGroup?
  clinicId         Int
  Clinic           Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  Appointment      Appointment[]
  PatientDoctor    PatientDoctor[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([clinicId])
  @@index([email, phone])
}

model Appointment {
  id               Int                 @id @default(autoincrement())
  scheduledTime    DateTime           
  actualStartTime  DateTime?           
  actualEndTime    DateTime?          
  duration         Int                 @default(15)   //it is in minutes
  status           AppointmentStatus   @default(PENDING)
  notes            String?
  isWalkIn         Boolean             @default(false)
  patientId        Int                
  Patient          Patient             @relation(fields: [patientId], references: [id])
  doctorId         Int?               
  Doctor           Doctor?             @relation(fields: [doctorId], references: [id])
  clinicId         Int                
  Clinic           Clinic              @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  Invoice          Invoice?
  Prescription     Prescription?
  EPrescription    EPrescription?
  createdAt        DateTime           @default(now())
  createdById      Int
  createdBy        User               @relation(fields: [createdById], references: [id])
  updatedAt        DateTime           @updatedAt

  @@index([clinicId, patientId])
  @@index([clinicId, doctorId])
}

model InvoiceItems {
  id            Int     @id @default(autoincrement())
  name          String
  quantity      Int
  amount        Float
  invoiceId     Int
  Invoice       Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model InvoicePrefills {
  id            Int     @id @default(autoincrement())
  name          String  @unique
  amount        Float
  clinicId      Int                
  Clinic        Clinic  @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([clinicId])
}

model Invoice {
  id               Int              @id @default(autoincrement())
  InvoiceItems     InvoiceItems[]
  modeOfPayment    ModeOfPayment?   // E.g., Cash, Card, UPI, etc.
  amountPaid       Float            @default(0)
  discountType     String?          @default("AMOUNT")
  discountValue    Float?           @default(0)
  appointmentId    Int              @unique 
  Appointment      Appointment      @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  lastUpdatedById  Int              // User ID of the last person who updated the invoice
  lastUpdatedBy    User             @relation(fields: [lastUpdatedById], references: [id], onDelete: Cascade)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  @@index([appointmentId])
}

model Prescription {
  id             Int              @id @default(autoincrement())
  screenshots    String[]         // URLs or file paths of the images
  appointmentId  Int              @unique
  Appointment    Appointment      @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([appointmentId])
}

model EPrescription {
  id             Int              @id @default(autoincrement())
  symptoms       String?
  diagnosis      String
  prescriptions  String           // JSON string of prescription items array
  advice         String
  appointmentId  Int              @unique
  Appointment    Appointment      @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([appointmentId])
}

model Doctor {
  id             Int       @id @default(autoincrement())
  firstName      String?   // Temporarily nullable for migration
  lastName       String?
  email          String?
  profilePicture String?
  degree         String?
  specialization String?
  experience     Int?      // in years
  Appointment    Appointment[]
  userId         Int?       @unique
  User           User?      @relation(fields: [userId], references: [id])
  clinicId       Int
  Clinic         Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  PatientDoctor  PatientDoctor[]
  isDeleted      Boolean   @default(false)
}

model PatientDoctor {
  patientId Int
  doctorId  Int

  Patient   Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  Doctor    Doctor  @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@id([patientId, doctorId]) // Composite primary key
}

model SubscriptionPlan {
  
  id                                Int      @id @default(autoincrement())
  name                              String   @unique          // Basic, Premium, Super Premium
  features                          String[]                  // Array of features
  isActive                          Boolean  @default(true)
  oneTimePrice                      Float
  subscriptionPrice                 Float
  razorPaySubscriptionPlanMonthlyId String? @unique
  razorPaySubscriptionPlanYearlyId  String? @unique

  Subscription Subscription[]
}

model Subscription {
  id                Int                @id @default(autoincrement())
  clinicId          Int
  planId            Int
  startDate         DateTime           @default(now())
  endDate           DateTime
  status            SubscriptionStatus @default(ACTIVE) // ACTIVE, EXPIRED, CANCELED
  isTrial           Boolean            @default(true)
  isMonthly         Boolean            @default(true) // true for monthly, false for yearly
  autoPay           Boolean            @default(false)
  subscriptionId    String?            @unique // Razorpay Subscription ID
  paymentRemaining  Int?               // Number of payments remaining for subscription
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  clinic            Clinic             @relation(fields: [clinicId], references: [id])
  SubscriptionPlan  SubscriptionPlan   @relation(fields: [planId], references: [id])
  Payment           Payment[]
}

model Payment {
  id                      Int      @id @default(autoincrement())
  subscriptionId          Int
  amount                  Float
  currency                String        @default("INR")
  status                  SubscriptionPaymentStatus @default(PENDING) // PENDING, SUCCESS, FAILED, REFUNDED
  order_id                String?  @unique
  subscription_payment_id String?  @unique
  payment_id              String?  @unique
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  refundedAt              DateTime?
  paidAt                  DateTime @default(now())
  notes                   String?

  Subscription            Subscription @relation(fields: [subscriptionId], references: [id])
}


model VerificationOTP {
  id          Int      @id @default(autoincrement())
  firstName   String
  lastName    String?
  email       String  @unique
  password    String
  clinicName  String?
  otp         String
  expiresAt   DateTime
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
}

enum Role {
  ADMIN
  DOCTOR
  RECEPTIONIST
}

enum ModeOfPayment {
  CASH
  CARD
  UPI
  ONLINE
}

enum SubscriptionPaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
}

enum Gender {
  MALE
  FEMALE
  OTHER
  NA
}

enum SubscriptionStatus {
  ACTIVE
  TRIAL
  EXPIRED
  CANCELED
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  ACTIVE
  STARTED
  COMPLETED
  CANCELLED  
}

enum BloodGroup {
  A_POS     // A+
  A_NEG     // A-
  B_POS     // B+
  B_NEG     // B-
  AB_POS    // AB+
  AB_NEG    // AB-
  O_POS     // O+
  O_NEG     // O-
}
